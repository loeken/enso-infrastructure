# network interface settings; autogenerated by enso
# Please do NOT modify this file directly, unless you know what
# you're doing.

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

{% for iface in existing_vmbr_interfaces %}
# Skip existing vmbr interface: {{ iface }}
{% endfor %}

{% set netmask_dict = {
  8: '255.0.0.0',
  16: '255.255.0.0',
  24: '255.255.255.0',
  32: '255.255.255.255'
} %}

{% for iface in physical_interfaces %}
{% set bridge_name = 'vmbr' ~ loop.index0 %}
# {% if loop.index == 1 %}WAN{% else %}LAN{% endif %} interface
auto {{ iface }}
iface {{ iface }} inet manual

{% if loop.index == 1 %}
# Bridge for the WAN interface
auto {{ bridge_name }}
iface {{ bridge_name }} inet manual
    address {{ ansible_facts.default_ipv4.address }}
    netmask {{ ansible_facts.default_ipv4.netmask }}
    gateway {{ ansible_facts.default_ipv4.gateway }}
{% else %}
# Bridge for the LAN interface
auto {{ bridge_name }}
iface {{ bridge_name }} inet manual
{% if create_opnsense == "true" and physical_interfaces|length >= 2 %}
    address {{ opnsense_ip.split('.')[0:3] | join('.') }}.254
    netmask {{ netmask_dict[opnsense_prefix|int] }}
{% endif %}
{% endif %}
    bridge-ports {{ iface }}
    bridge-stp off
    bridge-fd 0
{% if loop.index == 2 %}
    bridge-vlan-aware yes
{% endif %}
    bridge-vids 2-4094
{% endfor %}
